var db,ls,rsp,rs,ps,avatarChanged=!1;function translatescreen(){var e=getLangResources().tr;$("*[data-translate]:not(input):not(textarea)").each(function(a,r){var t=e[$(r).attr("data-translate")];t&&(r.innerText=t)}),$("input[data-translate]").each(function(a,r){var t=e[$(r).attr("data-translate")];t&&(r.placeholder=t)})}function showLoginScreen(){(ls=app.loginScreen.create({el:".login-screen"})).open(!0)}function showRegisterScreen(){(rs=app.popup.create({el:".register-screen",swipeToClose:!0})).open(!0)}function showResetPwScreen(){rsp=app.popup.create({el:".resetpassword-screen",swipeToClose:!0}),$(".firebase_resetpw_email").val($(".firebase_email").val()),rsp.open(!0)}if(firebase){var firebaseApp=firebase.initializeApp(firebaseConfig);firebaseApp||(firebase.auth().useDeviceLanguage(),db=firebase.firestore(),showAlert("Unable to initialize Firebase "))}else showAlert("Unable to initialize Firebase ");function firebase_handleProfileImage(e){if((e.size/1024/1024).toFixed(4)>firebaseImgMaxSize)showAlert("Image too large (Max: "+firebaseImgMaxSize+"Mb)"),avatarChanged=!1;else{var a=new FileReader;a.onload=function(a){var r=a.target.result;$(".firebase_profile_avatar").attr("src",r),$("#firebase_profile_avatar_input").data("data-file",e),avatarChanged=!0},a.readAsDataURL(e)}}function onFirebaseAvatarChange(e){firebase_handleProfileImage(e.target.files[0])}function firebase_auth_logout(){app.preloader.show(),firebase.auth().signOut().then(function(){app.preloader.hide(),app.view[0].router.navigate("/",{animate:!1,reloadAll:!0})}).catch(function(e){app.preloader.hide(),showAlert(e.message)})}function firebase_saveUserProfile(e){if(e){e.user.uid;var a=$("#firebase_register_displayname").val();$("#firebase_register_displayname").val();e.user&&(e.user.updateProfile({displayName:a,photoURL:"img/defaultavatar.png"}).catch(function(e){app.preloader.hide(),showAlert(e.message)}),app.preloader.hide(),$("#firebase_email").val($("#firebase_register_email").val()),$("#firebase_password").val($("#firebase_register_password").val()),rs.close(),ls&&ls.close(),$(".firebase_avatar").attr("alt",a),$(".firebase_avatar").attr("title",a),ShowNotification("Welcome "+a))}}firebase.auth().onAuthStateChanged(function(e){if(app.preloader.hide(),1!=requireInstallation)if(e){if(e&&1==e.isAnonymous&&0==firebaseAnonymous)return void firebase_auth_logout();e.displayName,e.email,e.emailVerified,e.photoURL,e.isAnonymous,e.uid,e.providerData;if($(".firebase-user-logout").show(),$("#firebase_login").hide(),$(".firebase_email").val(e.email),$(".firebase_displayname").text(e.displayName),1==e.isAnonymous)$(".firebase_avatar").attr("src","img/defaultavatar.png"),$(".firebase_avatar").attr("alt","anonymous"),$(".firebase_avatar").attr("title","anonymous");else{var a=e.photoURL||"img/defaultavatar.png";$(".firebase_avatar").attr("src",a),$(".firebase_avatar").attr("alt",e.displayName),$(".firebase_avatar").attr("title",e.displayName),$(".firebase_avatar").show()}$("#view-main").show(),ls&&ls.close()}else $("#auth_name").text(""),$("#auth_img").attr("src",""),$(".firebase-user-logout").hide(),$("#firebase_login").show(),$(".firebase_email").val(""),$(".firebase_displayname").text(""),$(".firebase_avatar").attr("src","img/defaultavatar.png"),$(".firebase_avatar").attr("alt",""),$(".firebase_avatar").attr("title",""),0==firebaseAnonymous?showLoginScreen():firebase.auth().signInAnonymously().catch(function(e){showAlert("Anonymous Login: "+e.message),showLoginScreen()})}),$(document).on("submit",".firebase-profile-form",function(e){var a=firebase.auth().currentUser;firebase.auth().photoURL;if(a){app.preloader.show();var r=a.uid;if(1==avatarChanged){var t=$("#firebase_profile_avatar_input").data("data-file"),i=t.name,s=(i=i.replace("C:\\fakepath\\","")).substr(i.lastIndexOf(".")+1);i=r+"."+s;firebase.storage().ref().child(firebaseStoragePath+"/").child(i).put(t).catch(function(e){app.preloader.hide(),showAlert(e.message)}).then(function(e){e.task.on("state_changed",function(e){var a=e.bytesTransferred/e.totalBytes*100;document.getElementById("firebase-upload-progress").value=a},function(e){app.preloader.hide(),showAlert(e.message)},function(){e.task.snapshot.ref.getDownloadURL().then(function(e){$(".firebase_avatar").attr("src",e),a.updateProfile({photoURL:e}).catch(function(e){app.preloader.hide(),showAlert(e.message)})})})})}var o=$("#firebase_profile_displayname").val();a.updateProfile({displayName:o}).catch(function(e){app.preloader.hide(),showAlert(e.message)}).then(function(e){setTimeout(function(){app.preloader.hide(),ps.close()},1e3)})}}),$("html").on("drop",function(e){e.preventDefault()}),$("html").on("dragover",function(e){e.preventDefault()}),$(document).on("dragenter",".firebase_profile_avatar",function(e){e.preventDefault(),$(this).css("opacity","0.5"),e.stopPropagation()}),$(document).on("dragleave",".firebase_profile_avatar",function(e){e.preventDefault(),$(this).css("opacity","1"),e.stopPropagation()}),$(document).on("drop",".firebase_profile_avatar",function(e){e.preventDefault();var a=e.dataTransfer.files[0];$(this).css("opacity","1"),firebase_handleProfileImage(a),e.stopPropagation()}),$(document).on("click",".firebase_profile_avatar",function(e){(e.preventDefault,1==isLocal()&&(app.device.ios||app.device.android))&&app.tooltip.create({targetEl:$(this),text:"Drop your file here"}).show();$(".firebase_profile_avatar_input").trigger("click")}),$(document).on("change",".firebase_profile_avatar_input",function(e){e.preventDefault(),onFirebaseAvatarChange(e)}),$(document).on("submit",".firebase-resetpw-form",function(e){e.preventDefault(),app.dialog.confirm("Reset Password?",function(){var e=$(".firebase_resetpw_email").val();e.length>0&&(app.preloader.show(),firebase.auth().sendPasswordResetEmail(e).then(function(){app.preloader.hide(),$(".firebase_email").val(e),showAlert("an email has been sent to your address"),rsp.close()}).catch(function(e){app.preloader.hide(),showAlert(e.message)}))})}),$(document).on("submit",".firebase-signin-form",function(e){e.preventDefault(),app.preloader.show();var a=$(".firebase_email").val(),r=$(".firebase_password").val();app.preloader.show(),firebase.auth().signInWithEmailAndPassword(a,r).then(function(){app.preloader.hide()}).catch(function(e){app.preloader.hide(),showAlert(e.message)})}),$(document).on("submit",".firebase-register-form",function(e){e.preventDefault(),app.preloader.show();var a=$("#firebase_register_email").val(),r=$("#firebase_register_password").val();if(r!=$("#firebase_register_password_verification").val())return app.preloader.hide(),showAlert("Password does not match"),void $("#firebase_register_password_verification").focus();if(r.length<6)return app.preloader.hide(),showAlert("Password must contain at least 6 characters"),void $("#firebase_register_password").focus();app.preloader.show();var t=firebase.auth().currentUser;if(t&&1==t.isAnonymous){var i=firebase.auth.EmailAuthProvider.credential(a,r);firebase.auth().currentUser.linkWithCredential(i).catch(function(e){app.preloader.hide(),showAlert(e.message)}).then(function(e){app.preloader.hide(),firebase_saveUserProfile(e)})}else firebase.auth().createUserWithEmailAndPassword(a,r).catch(function(e){app.preloader.hide(),showAlert(e.message)}).then(function(e){app.preloader.hide(),firebase_saveUserProfile(e)})}),$(document).on("click",".firebase_register",function(e){e.preventDefault(),showRegisterScreen()}),$(document).on("click",".firebase_resetpasswword",function(e){e.preventDefault(),showResetPwScreen()}),$(document).on("click",".firebase_editprofile",function(e){e.preventDefault(),ps=app.popup.create({el:".profile-screen",swipeToClose:!1}),$(".firebase_resetpw_email").val($(".firebase_email").val());var a=firebase.auth().currentUser;if(a){ps.open(!0),$(".firebase_profile_displayname").val(a.displayName),$(".firebase_profile_email").val(a.email);var r=a.photoURL||"img/defaultavatar.png";$(".firebase_profile_avatar").attr("src",r),$(".firebase-displayname").text(a.displayName)}}),$(document).on("click",".firebase-user-logout",function(e){e.preventDefault(),app.dialog.confirm("Logout?",firebase_auth_logout)}),$(document).on("click",".firebase_fb_login",function(e){e.preventDefault();var a=new firebase.auth.FacebookAuthProvider;a.addScope("user_birthday"),firebase.auth().signInWithPopup(a).then(function(e){e.credential.accessToken,e.user}).catch(function(e){app.preloader.hide(),showAlert(e.message)})}),$(document).on("click",".firebase_google_login",function(e){e.preventDefault();var a=new firebase.auth.GoogleAuthProvider;a.addScope("profile"),a.addScope("email"),firebase.auth().signInWithPopup(a).then(function(e){e.credential.accessToken,e.user}).catch(function(e){app.preloader.hide(),showAlert(e.message)})}),$(document).on("click",".firebase_twitter_login",function(e){e.preventDefault();var a=new firebase.auth.TwitterAuthProvider;firebase.auth().signInWithPopup(a).then(function(e){e.credential.accessToken,e.user}).catch(function(e){app.preloader.hide(),showAlert(e.message)})}),$(document).on("click",".firebase_avatar",function(e){(e.preventDefault(),1==firebase.auth().currentUser.isAnonymous)?1==(firebaseAllowRegister||!1)&&showLoginScreen():app.popover.open(".firebase-popover",$(this),!0)}),$(document).on("input",".firebase_profile_displayname",function(e){$(".firebase-displayname").text($(".firebase_profile_displayname").val())}),$(document).on("page:init",function(e){var a=firebase.auth().currentUser,r=a.photoURL||"img/defaultavatar.png";$(".firebase_avatar").attr("src",r),$(".firebase_avatar").attr("alt",a.displayName),$(".firebase_avatar").attr("title",a.displayName)}),1==app.initialized&&($("#view-main").hide(),translatescreen(),$(".login-screen-title").text(app.name),app.preloader.show());